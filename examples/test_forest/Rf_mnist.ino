/*
 * Digit Recognition Example
 * 
 * This example demonstrates handwritten digit classification (0-9) using a Random Forest
 * model trained on extracted features from digit images.
 * 
 * Features:
 * - Trains and evaluates Random Forest model for multi-class classification
 * - Performs predictions on 10 sample feature vectors (144 features each)
 * - Classifies digits from 0 to 9
 * - Calculates accuracy and timing metrics
 * 
 * Hardware: ESP32 or compatible microcontroller with LittleFS support
 * Dataset: Handwritten digits with normalized pixel/feature values
 */

#define DEV_STAGE    
#define RF_DEBUG_LEVEL 2
#define RF_USE_PSRAM

#include "random_forest_mcu.h"

using namespace mcu;

const RfStorageType STORAGE_MODE = RfStorageType::SD_MMC_1BIT;

void setup() {
    Serial.begin(115200);  
    while (!Serial);       // <-- Waits for Serial monitor to connect (important for USB CDC)

    Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Serial.println("â•‘  Digit Recognition - Random Forest Example         â•‘");
    Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    delay(1000);

    // Initialize filesystem
    Serial.print("ðŸ’¾ Initializing file system... ");
    if (!RF_FS_BEGIN(STORAGE_MODE)) {
        Serial.println("âŒ FAILED!");
        Serial.println("âš ï¸  File system initialization failed. Cannot continue.");
        return;
    }
    
    
    manage_files();
    delay(500);
    
    long unsigned start_forest = GET_CURRENT_TIME_IN_MILLISECONDS;
    
    // Initialize Random Forest model
    const char* model_name = "mnist";
    RandomForest forest = RandomForest(model_name);
    
    // Optional: Configure forest parameters
    // forest.set_num_trees(20);
    // forest.set_random_seed(42);
    // forest.disable_partial_loading();
    // forest.set_training_score(Rf_training_score::OOB_SCORE);

    // Build and train the model
    // if (!forest.build_model()) {
    //     Serial.println("âŒ FAILED");
    //     return;
    // }

    // long unsigned build_time = GET_CURRENT_TIME_IN_MILLISECONDS;
    // Serial.printf("Model built in %lu ms\n", build_time - start_forest);

    // forest.training(2); // limit to 3 epochs

    // Load trained forest from filesystem
    Serial.print("Loading forest... ");
    if (!forest.loadForest()) {
        Serial.println("âŒ FAILED");
        return;
    }

    Serial.printf("bits per node: %d\n", forest.bits_per_node());
    Serial.printf("model size in ram: %d\n", forest.model_size_in_ram());
    
    // Optional: Enable dataset extension for online learning
    // forest.enable_extend_base_data();

    // check actual prediction time 
    b_vector<float> sample_1 = MAKE_FLOAT_LIST(0,0,0,0,0.338931,0.0849891,0.108983,0,0.372746,0,0,0.0435834,0.508884,0.133888,0.669323,0.0174189,0.205989,0.010774,0.0117243,0,0.0483697,0.261165,0.0748055,0.0581938,0.504469,0.10048,0.480534,0.0380234,0.386415,0.210235,0.335233,0.273763,0.226574,0.401107,0.121667,0.0865669,0,0,0.00705189,0,0.587733,0.160392,0.473565,0.315351,0,0.153414,0.192538,0.0997949,0.190128,0,0,0,0.471663,0.00223563,0.548852,0.0127152,0.0945377,0,0,0.102294,0.431115,0.261204,0.193018,0.359494,0.47034,0.00175067,0.35984,0.00404842,0.193365,0.274548,0.202357,0.237961,0.167071,0.204542,0.0947133,0.291994,0.296821,0.00638004,0.423876,0.0845018,0.345628,0.248561,0.249008,0.260986,0,0.0996192,0.127661,0.0459302,0.494421,0.00878495,0.636581,0.100921,0,0,0.00194267,0.0188716,0.272552,0,0,0.145106,0.487096,0.370521,0.413524,0.509352,0,0,0,0,0.224143,0,0,0.222327,0.312553,0.262547,0.22058,0.374378,0.420542,0.0351612,0.532097,0.16181,0,0,0,0.000421338,0.171606,0.118787,0.226164,0.249908,0.60043,0.0398791,0.648309,0.121208,0,0,0.0570028,0.0729324,0.190821,0.132088,0.251488,0.277891,0,0,0,0);
    b_vector<float> sample_2 = MAKE_FLOAT_LIST(0,0,0,0,0.294134,0.24344,0,0,0.172372,0,0,0,0.519918,0.273359,0.620405,0.307519,0.189512,0.0817086,0,0,0.0348237,0.286897,0,0,0.487182,0.208491,0.438645,0.128207,0.339355,0.180259,0.429541,0.228177,0.131417,0.411054,0,0,0,0,0,0,0.414684,0.264914,0.690444,0.288961,0,0,0.106824,0,0.106645,0,0,0,0.653484,0.409492,0.354223,0.126825,0.0388074,0,0,0,0.369364,0.0265987,0.250747,0.225445,0.496451,0.20594,0.221005,0.00641687,0.186583,0.361462,0.226494,0.176552,0.0271402,0.018602,0.175362,0.157667,0.422899,0,0.422807,0,0.276386,0.487124,0.302593,0.208235,0,0,0.0735086,0,0.481296,0,0.560656,0,0,0,0.0034719,0,0.12228,0,0,0,0.536231,0.320463,0.399659,0.353812,0,0,0,0,0.493617,0,0,0.25737,0.168458,0.18339,0.228711,0.202475,0.547746,0,0.548562,0,0,0,0,0,0.290856,0.17065,0.301674,0.197518,0.570528,0.0275376,0.638883,0,0,0,0.0336295,0,0.302954,0.177747,0.314222,0.205733,0,0,0,0);
    b_vector<float> sample_3 = MAKE_FLOAT_LIST(0,0,0,0,0.385757,0.0376213,0,0,0.0609396,0.0796556,0,0,0.684051,0.0767057,0.17819,0.578062,0.139075,0.00240186,0,0,0.297229,0.438584,0,0,0.465411,0.0506844,0.0438283,0.335614,0.207408,0.239138,0.492755,0.152336,0.461396,0.269843,0,0,0,0.235238,0.00273138,0,0.410647,0.188965,0.318392,0.362051,0,0.150389,0.446693,0.0030728,0,0,0,0,0.588543,0.047373,0.0402117,0.131275,0.21491,0.228515,0,0.353192,0.332821,0.241909,0.289003,0.395678,0.403192,0.0215224,0,0.0933561,0.249644,0.203101,0.311417,0.0557804,0.17924,0.355985,0.137672,0.36734,0.151664,0.127022,0.516377,0.0778937,0.525842,0.094663,0.167336,0.166555,0,0.220613,0.325504,0.00226862,0.286754,0.113548,0.60104,0.197024,0,0.0502025,0.0803167,0,0.243864,0.260218,0,0.160666,0.577105,0.326403,0.0765267,0.354051,0.000860831,0,0,0.292458,0,0.00172166,0.361711,0.24461,0.387583,0.43541,0.0357017,0.249973,0.175556,0.175336,0.565754,0.0719035,0,0.0015652,0.222879,0.334647,0,0,0.215426,0.039391,0.46299,0.243349,0.622179,0.245454,0,0.0740541,0.235109,0.00297463,0,0,0.45522,0.105228,0,0,0,0);
    b_vector<float> sample_4 = MAKE_FLOAT_LIST(0,0,0,0,0.287608,0.248409,0.0783915,0.00621901,0.255232,0,0,0.0478656,0.545775,0.359916,0.595045,0.021643,0.202821,0.129192,0.0330059,0.00438564,0.107497,0.126583,0.0587698,0,0.477526,0.23758,0.401129,0.0442779,0.520321,0.0985582,0.426875,0.0047395,0.190982,0.235974,0.076273,0.00605095,0,0.0995947,0.0503517,0,0.717897,0.229344,0.453184,0.00653918,0,0.0398168,0.338459,0,0.115634,0,0,0,0.482252,0.0875681,0.519862,0.014031,0.0996484,0,0,0.088777,0.276575,0.316905,0,0.530289,0.429489,0.0253185,0.358075,0.00622501,0.380995,0.0964258,0.329186,0.00390915,0.0749049,0.203872,0,0.355062,0.287029,0.0895646,0.388491,0.0960784,0.527405,0.0875528,0.395122,0.0104187,0,0.0809758,0.265971,0,0.39733,0.221717,0.447454,0.254359,0,0.0234335,0.0903266,0,0.263535,0,0,0.117892,0.268228,0.420836,0.192271,0.704201,0,0,0,0,0.345587,0,0.0462019,0.114762,0.244169,0.272299,0.139675,0.474233,0.393425,0.128808,0.511336,0.128326,0.0293693,0,0,0,0.221681,0,0.338662,0.0884591,0.49966,0.271691,0.508553,0.311691,0,0.0403764,0.140857,0,0.318841,0,0.43011,0.112345,0,0,0,0);
    b_vector<float> sample_5 = MAKE_FLOAT_LIST(0,0,0,0,0.366034,0.212608,0,0,0.0243807,0,0,0,0.724475,0.169526,0.472277,0.208745,0.199832,0.0417935,0,0,0.263146,0.171629,0.065623,0.0252432,0.390697,0.0580263,0.198484,0.100794,0.553766,0.0610958,0.575588,0.086119,0.262887,0.215802,0.0700526,0.00155181,0.122472,0.145951,0.0896734,0.0253953,0.554357,0.0928937,0.533736,0.112752,0.135149,0,0.450137,0.00258635,0,0,0,0,0.413825,0.075417,0.309292,0.136706,0.347601,0.0099799,0.0869183,0.126182,0.480499,0.164705,0.520418,0.188325,0.273117,0.0131422,0.152717,0.0775525,0.469799,0.061947,0.369127,0.0791569,0.434042,0.0928129,0.406627,0.0263776,0.123678,0.213122,0.286334,0.15191,0.474179,0.0849262,0.372858,0.0892306,0.166984,0.0624842,0.44947,0.0237231,0.247227,0.278536,0.46465,0.178686,0,0,0.00708917,0,0.422271,0.0131422,0.0292716,0,0.646443,0.227172,0.402929,0.127064,0.0354727,0,0.112245,0.240606,0.0353069,0,0.282391,0.141157,0.575277,0.123014,0.264995,0,0.308456,0.225972,0.478803,0.103348,0,0,0.294111,0.0801751,0.0549737,0.0982171,0.167582,0.252742,0.538632,0.327619,0.612067,0.131567,0,0,0.178011,0,0.0699842,0.125035,0.234222,0.321754,0,0,0,0);
    b_vector<float> sample_6 = MAKE_FLOAT_LIST(0,0,0,0,0.3894,0.0855438,0.120552,0.0258787,0.190197,0,0,0,0.564282,0,0.686207,0.0194837,0.231557,0.0148967,0.0283026,0,0.0662663,0.338915,0.0786764,0.0866471,0.494467,0,0.506904,0.00143504,0.295614,0.0710157,0.408459,0.227341,0.278354,0.499736,0.130713,0.122838,0,0,0.0209499,0,0.419088,0.100678,0.551007,0.322298,0,0,0.216595,0,0.068485,0,0,0,0.614159,0.00145445,0.562262,0.0384932,0.177137,0,0,0.104279,0.143308,0.401203,0.162394,0.224436,0.470391,0.00111711,0.362128,0.00122289,0.138046,0.169468,0.314173,0.26757,0.185617,0.305104,0.124729,0.210621,0.316024,0.0668267,0.331114,0.167583,0.286752,0.249329,0.502182,0.393662,0,0,0.162263,0,0.46495,0.147853,0.291718,0.246557,0,0,0.195433,0,0.241417,0,0,0.123342,0.254326,0.259443,0.346566,0.142148,0.0372219,0,0,0,0.0817687,0.414567,0.0435939,0.687284,0.311523,0.200326,0.267597,0.155228,0.261805,0.116657,0.357847,0.318267,0.029954,0.260605,0,0.444734,0.212947,0.0594985,0.358989,0.106111,0.373481,0.166418,0.260528,0.454027,0,0,0.249962,0,0.303782,0.262641,0.481455,0.319871,0,0,0.0306639,0);
    b_vector<float> sample_7 = MAKE_FLOAT_LIST(0,0,0,0,0.384239,0.0605373,0.140195,0,0,0,0,0,0.697433,0.130101,0.522868,0.228717,0.18027,0.013587,0,0,0.110897,0.31782,0.168331,0.0889651,0.309356,0.0705234,0.145227,0.152676,0.418046,0.0491034,0.703925,0.000770057,0.268797,0.252629,0.144702,0.0914717,0,0.088115,0.0283712,0,0.506424,0.0892938,0.735605,0.0215409,0,0.0337035,0.137472,0,0,0,0,0,0.528658,0.0725513,0.310873,0.0948358,0.0114839,0,0,0,0.597829,0.233092,0.427083,0.12393,0.313463,0.0544434,0.117031,0.0803547,0.354016,0.123265,0.578429,0.0731534,0.516273,0.012346,0.173434,0.105007,0,0.185153,0.23684,0,0.570054,0.103322,0.652816,0.084949,0,0.102383,0.152209,0,0.148372,0.228614,0.340158,0.0856856,0,0,0,0,0,0,0,0,0.581103,0.255111,0.292451,0.192463,0.0325885,0,0,0,0.324648,0.12801,0.464303,0.369116,0.499457,0.0808862,0.110178,0.206036,0.122627,0.192216,0.437983,0.00088321,0.38243,0.068758,0.272348,0.393822,0,0.0682796,0.246337,0.00132481,0.259885,0.360614,0.68426,0.116096,0,0,0,0,0.234117,0.0901589,0.498001,0.0989073,0,0,0,0);
    b_vector<float> sample_8 = MAKE_FLOAT_LIST(0,0,0,0,0.408737,0.223759,0.190343,0.0984968,0.277177,0,0,0.129576,0.319799,0.234795,0.663612,0.213392,0.263168,0.0914508,0.0982761,0.0326975,0.187464,0.152773,0.312479,0.0492583,0.418717,0.0968962,0.452415,0.165242,0.0322238,0.470931,0.0832164,0.326595,0.30782,0.319223,0.469434,0.109689,0,0,0.0506604,0,0.0925667,0.529366,0.137902,0.480129,0,0.157982,0.07128,0,0.218553,0,0,0.0892039,0.443198,0.185136,0.673341,0.23094,0.0846894,0.0168561,0,0.0916886,0.0456998,0.43075,0,0.0579587,0.473567,0.0771431,0.438428,0.137075,0.00936721,0.315594,0.200098,0.205624,0.0677368,0.299719,0,0.109832,0.363312,0.115405,0.332029,0.121357,0.053951,0.438129,0.436318,0.35792,0,0.0482001,0.00735597,0,0.505497,0.136284,0.0571562,0.168851,0,0.120504,0.404815,0,0.119667,0.0220545,0,0.133679,0,0.143534,0.351664,0.1849,0.0424124,0,0,0.116542,0.105976,0.515627,0.0481044,0.702901,0.0803234,0.115894,0.216367,0.164143,0.249222,0.274472,0.304144,0.332923,0.0366464,0.292631,0,0.472535,0.236405,0.09002,0.40536,0.164311,0.323177,0.159742,0.100149,0.473117,0,0.196179,0.352728,0,0.306557,0.273445,0.381969,0.371447,0,0,0.143678,0);
    b_vector<float> sample_9 = MAKE_FLOAT_LIST(0,0,0,0,0.307141,0.029659,0.0170699,0.0170699,0,0,0,0,0.942847,0.0102442,0.123029,0.000301756,0.0143638,0.0133617,0.0133617,0.0133617,0.29472,0.267925,0.12126,0,0.488002,0,0,0,0.250023,0.00801874,0.724699,0.000236203,0.274513,0.248709,0.112563,0,0,0,0,0,0.63048,0.00744363,0.672723,0.000219262,0,0,0,0,0,0,0,0,0.619319,0,0.0168019,0.0113911,0,0,0,0,0.600345,0.014256,0.505049,0.0184277,0.242043,0,0.00235834,0.0104815,0.339756,0.0499517,0.516515,0,0.552406,0.00682734,0.0648663,0.0167709,0,0.00629026,0.496845,0.000185288,0.593429,0.0515774,0.533326,0,0,0,0,0,0.154482,0.0135445,0.579992,0.0175081,0,0,0,0,0,0,0,0,0.681902,0.00849826,0.414115,0.0207087,0,0,0,0,0.263359,0.00752237,0.477552,0.256021,0.612856,0.00075038,0.00884427,0.0188373,0.0142755,0.00706529,0.631579,0.000208118,0.242206,0.00691816,0.303949,0.235457,0,0,0.135246,0,0.399766,0.00948187,0.776953,0.0231056,0,0,0,0,0,0.00839302,0.485173,0.0210671,0,0,0,0);
    b_vector<float> sample_10 = MAKE_FLOAT_LIST(0,0,0,0,0.393749,0.130594,0.174256,0.000715475,0.0627927,0,0,0,0.72723,0,0.514524,0,0.356516,0.011575,0.0210437,0,0.0334888,0.178373,0.218145,0.00342524,0.595836,0,0.477515,0,0.330474,0.289202,0.12606,0,0.280424,0.27968,0.352181,0.00504333,0,0,0,0,0.613965,0.200956,0.457449,0,0,0.224864,0.204756,0,0.0218151,0,0,0,0.638069,0,0.532514,0,0.0471789,0,0,0.0426612,0.322808,0.0649792,0.176392,0.406489,0.471364,0,0.337895,0,0.242958,0.253327,0.15436,0.00237959,0.278395,0.057936,0.120856,0.400466,0.0514885,0,0.508037,0.00382804,0.376593,0.17639,0.591,0.00351091,0,0.197376,0.0190811,0,0.297023,0.0105327,0.483722,0.0783794,0,0,0.331642,0,0.0838755,0,0,0.0559059,0.729609,0.0851529,0.33428,0.274653,0,0,0,0,0,0,0.0987464,0.50332,0.526956,0.0769172,0.301949,0.298588,0.251211,0.154326,0.496902,0.00453276,0,0,0,0.347517,0,0,0.261098,0.115227,0.603818,0.0361687,0.414532,0.00592899,0,0.178091,0.412798,0,0,0,0.341524,0.378769,0,0,0,0);
    
    vector<b_vector<float>> samples;
    samples.push_back(sample_1);
    samples.push_back(sample_2);
    samples.push_back(sample_3);
    samples.push_back(sample_4);
    samples.push_back(sample_5);
    samples.push_back(sample_6);
    samples.push_back(sample_7);
    samples.push_back(sample_8);
    samples.push_back(sample_9);
    samples.push_back(sample_10);

    vector<uint8_t> true_labels = MAKE_UINT8_LIST(9,7,3,4,2,0,8,5,1,6);

    // Perform predictions on all samples
    unsigned long total_time = 0;
    uint8_t correct_predictions = 0;

    // Warm-up prediction to cache initialization (optional)
    Serial.print("Warming up inference engine... ");
    forest.warmup_prediction();
    
    Serial.println("\n=== Prediction Results ===");
    Serial.println("Sample | Predicted | Actual | Time (Î¼s) | Match");
    Serial.println("-------|-----------|--------|-----------|------");
    
    rf_predict_result_t result;
    for (int i = 0; i < samples.size(); i++){
        forest.predict(samples[i], result); 
        if (!result.success) {
            Serial.printf("  %2d   | FAILED    |        |           | âœ—\n", i+1);
            continue;
        }
        
        total_time += result.prediction_time;
        forest.add_actual_label(true_labels[i]);
        
        bool is_correct = (atoi(result.label) == true_labels[i]);
        const char* match = is_correct ? "âœ“" : "âœ—";
        if (is_correct) correct_predictions++;
        
        Serial.printf("  %2d   | %-9s | %6d | %9lu | %s\n", 
                     i+1, result.label, true_labels[i], 
                     result.prediction_time, match);
    }
    
    Serial.println("-----------------------------------------------");
    Serial.printf("Total samples: %d\n", samples.size());
    Serial.printf("Correct predictions: %d/%d (%.1f%%)\n", 
                  correct_predictions, samples.size(), 
                  (correct_predictions * 100.0f) / samples.size());
    Serial.printf("Average prediction time: %lu Î¼s\n", total_time / samples.size());
    Serial.println();
    
    // Clean up and compute statistics
    Serial.print("Releasing forest from memory... ");
    if (forest.releaseForest()) {
        Serial.println("âœ… OK");
    } else {
        Serial.println("âš ï¸  WARNING: Release failed");
    }
    
    // Optional: Write pending data to dataset for retraining
    // forest.flush_pending_data();

    // Display inference statistics
    Serial.println("\n=== Model Performance Metrics ===");
    float p_score = forest.get_practical_inference_score();
    Serial.printf("Practical Inference Score: %.3f (%.1f%%)\n", p_score, p_score * 100.0f);
    
    int total_logged = forest.get_total_logged_inference();
    Serial.printf("Total Logged Inferences: %d\n", total_logged);

    long unsigned end_forest = GET_CURRENT_TIME_IN_MILLISECONDS;
    Serial.println("\n=== Execution Summary ===");
    Serial.printf("Total execution time: %lu ms\n", end_forest - start_forest);
    Serial.println("\nâœ… Example completed successfully!\n");
}

void loop() {
    // Empty loop - all processing done in setup()
}