# HOG Configuration Transfer Utility

This utility transfers HOG configuration files generated by `hog_processor` from PC to ESP32 over serial connection.

## Overview

After running `hog_processor` on your PC, it generates a `model_name_hogcfg.json` file containing all the HOG parameters needed by the ESP32. This tool transfers that config file to the ESP32's filesystem (LittleFS or SD card) in a `/<model_name>/` folder structure.

## Files

```
data_transfer/
‚îú‚îÄ‚îÄ pc_side/
‚îÇ   ‚îî‚îÄ‚îÄ transfer_hog_config.py    # Python script to send config from PC
‚îî‚îÄ‚îÄ esp32_side/
    ‚îî‚îÄ‚îÄ hog_config_receiver.ino   # Arduino sketch to receive config on ESP32
```

## Quick Start

### Step 1: Generate HOG Config on PC
```bash
cd /path/to/STL_MCU/tools/hog_transform
make run  # or make test

# This generates:
# - dataset_features.csv (feature vectors for ML)
# - dataset_features_hogcfg.json (config for ESP32)
```

### Step 2: Upload Receiver Sketch to ESP32
1. Open `hog_config_receiver.ino` in Arduino IDE
2. Select your ESP32 board and port
3. Upload the sketch
4. Open Serial Monitor (115200 baud) to see status

### Step 3: Transfer Config File
```bash
cd /path/to/STL_MCU/tools/hog_transform/data_transfer/pc_side

# Install pyserial if not already installed
pip3 install pyserial

# Transfer the config
python3 transfer_hog_config.py dataset_features /dev/ttyUSB0

# On Windows:
python3 transfer_hog_config.py dataset_features COM3
```

### Step 4: Use Config in Your ESP32 Code
```cpp
#include "hog_transform.h"
#include "Rf_file_manager.h"

HogTransform hog;

void setup() {
    // Initialize filesystem
    RF_FS_BEGIN();
    
    // Load config from transferred file (saved in /model_name/ folder)
    if (hog.loadConfigFromFile("/dataset_features/dataset_features_hogcfg.json")) {
        Serial.println("‚úÖ HOG config loaded successfully!");
        
        // Now use hog.extract() with camera images
    } else {
        Serial.println("‚ùå Failed to load HOG config");
    }
}
```

## Prerequisites

### PC Side
- Python 3.x
- pyserial library: `pip3 install pyserial`
- Generated `*_hogcfg.json` file from `hog_processor`

### ESP32 Side
- ESP32 board with Arduino framework
- STL_MCU library installed
- LittleFS or SD card support (via `Rf_file_manager.h`)

## Usage Examples

### Basic Transfer
```bash
# Transfer dataset_features_hogcfg.json
python3 transfer_hog_config.py dataset_features /dev/ttyUSB0
```

### Different Model Names
```bash
# Transfer custom_model_hogcfg.json
python3 transfer_hog_config.py custom_model /dev/ttyUSB0

# Transfer digits_hogcfg.json
python3 transfer_hog_config.py digits /dev/ttyUSB0
```

### Using SD Card Instead of LittleFS

Edit `hog_config_receiver.ino` and change the storage mode:

```cpp
// Choose one of:
const RfStorageType STORAGE_MODE = RfStorageType::SD_MMC;    // Built-in SD slot (ESP32-CAM)
// const RfStorageType STORAGE_MODE = RfStorageType::SD_SPI; // External SPI SD card module
// const RfStorageType STORAGE_MODE = RfStorageType::FLASH; // Internal flash (default)
```

The storage mode is passed to `RF_FS_BEGIN()` during initialization, ensuring the correct backend is used.

## Protocol Details

The transfer protocol is based on the Random Forest model transfer system:
- **Header**: `ESP32_XFER` command prefix
- **Commands**: START_SESSION, FILE_INFO, FILE_CHUNK, END_SESSION
- **Chunk Size**: 256 bytes
- **CRC Verification**: Both per-chunk and full-file CRC32
- **Retry Logic**: Up to 5 retries per chunk with ACK/NACK feedback

## Troubleshooting

### "No HOG config file found"
- Make sure you've run `hog_processor` first
- Check that `model_name_hogcfg.json` exists in the parent directory
- Verify the model name matches the generated file

### "Failed to connect" or "Port not found"
- Check the serial port name (Linux: `/dev/ttyUSB0`, Windows: `COM3`)
- Ensure no other program is using the serial port (close Arduino Serial Monitor)
- Try pressing the RESET button on the ESP32

### "ESP32 did not respond with READY"
- Make sure `hog_config_receiver.ino` is uploaded to the ESP32
- Press the RESET button on the ESP32
- Open Arduino Serial Monitor to see what the ESP32 is doing
- Check that the baud rate is 115200

### "CRC mismatch"
- USB cable quality issue - try a different cable
- Power supply issue - try external power
- Retry the transfer

### "File system initialization failed"
- For LittleFS: The partition may need to be formatted (happens automatically on first use)
- For SD card: Check SD card is inserted and formatted as FAT32
- Check the `RF_USE_SDCARD` or `RF_USE_SDSPI` defines match your hardware

## File Size and Storage

- Typical HOG config file size: **~600 bytes**
- Directory structure: `/<model_name>/<filename>`
- ESP32 LittleFS default partition: **~1.5 MB** (plenty of space for multiple configs)
- SD card: Up to card capacity

## Advanced Usage

### Transfer Multiple Configs
```bash
# Transfer different model configs
python3 transfer_hog_config.py model_a /dev/ttyUSB0
# Press RESET on ESP32, then:
python3 transfer_hog_config.py model_b /dev/ttyUSB0
```

### Verify Transfer Success
Open Arduino Serial Monitor after transfer:
```
üéâ HOG config transfer completed!
üìà Successfully received 1 files

üìÅ HOG config files in file system:
   üìã /dataset_features/dataset_features_hogcfg.json (611 bytes) - HOG Configuration
   Total: 1 files (1 HOG configs)
   ‚úÖ HOG configuration ready for use!

   üí° Load config in your code with:
      hog.loadConfigFromFile("/dataset_features/dataset_features_hogcfg.json");
```

## Comparison with Manual Config

| Method | Pros | Cons |
|--------|------|------|
| **File Transfer** | ‚úÖ Parameters guaranteed to match PC training<br>‚úÖ Easy to update<br>‚úÖ No code recompilation needed | ‚ö†Ô∏è Requires serial transfer step |
| **Hardcoded Config** | ‚úÖ No transfer needed | ‚ùå Error-prone<br>‚ùå Must recompile to change<br>‚ùå Parameter mismatch risk |

## Related Tools

- **hog_processor**: Generates the HOG config file (in parent directory)
- **HOG_ESP32CAM**: Complete example with quick start, config file loading, and custom parameters

## Support

If you encounter issues:
1. Run the diagnostic from `hog_processor` README
2. Check Arduino Serial Monitor output
3. Verify file exists with correct name: `ls -l *_hogcfg.json`
4. Try a simple transfer with verbose output

## License

Part of the STL_MCU library - see main LICENSE file.
